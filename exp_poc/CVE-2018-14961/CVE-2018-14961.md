# CVE-2018-14961 ZZCMS 8.3 SQL Injection

## 复现环境搭建

CentOS上也可以部署，可以参考[这个文章](https://blog.csdn.net/caiqiiqi/article/details/82813388) ，不过Linux部署的话还是建议做成docker镜像。

简易版：Win10 + Phpstudy Pro(现小皮面板) 8.1.X + Apache 2.4.39 + MySQL 5.7.26 + PHP 5.4.45nts

域名直接用本地映射，配置修改参考如下图：
![phpstudy_config](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611100144.png)

[zzcms 8.3 下载地址](https://pan.baidu.com/s/1vFT6pG31J7NMKtRsbt1fLQ)

zzcms 8.3 下载后，将压缩包中的文件解压到`phpStudy\WWW\zzcms` 文件夹下面

安装流程参考zzcms自带的`安装说明.txt`

![step1](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611101158.png)

这个是后台管理员的账户信息
![step2](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611101340.png)

然后去前端访问测试网站 `http://zzcms.tt`

要现注册一个普通用户，注意这里有坑，不改代码的情况下，这里实际只能注册公司账户，而且公司名称验证那里的逻辑处理也挺让人无语的。

```
define('wordsincomane','医|药|生物|览|展|会|保健|广告|包装|印刷') ;//公司名称中必填行业性关键字
define('lastwordsincomane','集团|公司|厂|药店|药房|部') ;//公司名称中必填公司类型性关键字
```

注册普通用户后，登录 -> 进入用户中心 -> 群发信息 -> 邮件/短信内容设置 -> 添加一个模板并将其设为默认.

![step3](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611104738.png)

访问 `http://zzcms.tt/dl/dl_sendmail.php` ，如果页面显示“完成”，说明准备工作完成。

运行exp获取结果：
![step4](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611101441.png)

去解密网站可以查询这个hash解密后的明文。
![result](https://cdn.jsdelivr.net/gh/TesterCC/pic_bed2/20210611101609.png)

## 漏洞分析

一个前台的sql注入漏洞，发现又是使用了stripfxg这个函数解除了自己的过滤，但是其实这里即使没有引号，也是可以直接注入的，下面详细分析一下：
代码出现问题是在：`/dl/dl_sendmail.php`。

```php
if (!empty($_POST["sql"])){//从模板中获取SQL内容,为发送对像
$_SESSION['sql']=stripfxg($_POST["sql"]);
}
$sql=$_SESSION['sql'];
```

## REF

- [zzcms 8.3 最新CVE漏洞分析](https://www.anquanke.com/post/id/156660#h2-2) 建议PHP代码审计把这个系列的CVE都走一波
- [zzcms 8.3 CVE漏洞分析](https://xz.aliyun.com/t/2775) 不过这个图片貌似都挂了
- [zzcms v8.2 中的众多cve分析](https://www.anquanke.com/post/id/153885)